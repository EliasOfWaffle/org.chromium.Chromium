From fcc07ee77995875f0d93c34e2bd8aadc81ede3bf Mon Sep 17 00:00:00 2001
From: Ryan Gonzalez <git@refi64.dev>
Date: Tue, 18 Apr 2023 20:34:51 -0500
Subject: [PATCH] Preserve EGL errors

---
 ui/gl/gl_context_egl.cc | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/ui/gl/gl_context_egl.cc b/ui/gl/gl_context_egl.cc
index 42928e27f16f4..574c33339b60f 100644
--- a/ui/gl/gl_context_egl.cc
+++ b/ui/gl/gl_context_egl.cc
@@ -90,6 +90,7 @@
 #define EGL_CONTEXT_VIRTUALIZATION_GROUP_ANGLE 0x3481
 #endif /* EGL_ANGLE_context_virtualization */
 
+using ui::GetEGLErrorString;
 using ui::GetLastEGLErrorString;
 
 namespace gl {
@@ -345,8 +346,9 @@ bool GLContextEGL::Initialize(GLSurface* compatible_surface,
   // If EGL_KHR_no_config_context is in use and context creation failed,
   // it might indicate that an unsupported ES version was requested. Try
   // falling back to a lower version.
+  GLint error = context_ ? EGL_SUCCESS : eglGetError();
   if (!context_ && gl_display_->ext->b_EGL_KHR_no_config_context &&
-      eglGetError() == EGL_BAD_MATCH) {
+      error == EGL_BAD_MATCH) {
     // Set up the list of versions to try: 3.1 -> 3.0 -> 2.0
     std::vector<std::pair<EGLint, EGLint>> candidate_versions;
     if (context_client_major_version == 3 &&
@@ -373,13 +375,15 @@ bool GLContextEGL::Initialize(GLSurface* compatible_surface,
       // Stop searching as soon as a context is successfully created.
       if (context_) {
         break;
+      } else {
+        error = eglGetError();
       }
     }
   }
 
   if (!context_) {
     LOG(ERROR) << "eglCreateContext failed with error "
-               << GetLastEGLErrorString();
+               << GetEGLErrorString(error);
     return false;
   }
 
-- 
2.39.2

